<!DOCTYPE html>
<html>
<head>
  <title>Frontend Tracking Test</title>
  <style>
    body {
      font-family: monospace;
      padding: 20px;
      background: #1e1e1e;
      color: #00ff00;
    }
    .log {
      background: #000;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #00ff00;
      max-height: 400px;
      overflow-y: auto;
    }
    button {
      background: #00ff00;
      color: #000;
      border: none;
      padding: 10px 20px;
      margin: 5px;
      cursor: pointer;
      font-family: monospace;
      font-weight: bold;
    }
    button:hover {
      background: #00cc00;
    }
    .error {
      color: #ff0000;
    }
    .success {
      color: #00ff00;
    }
    .info {
      color: #ffff00;
    }
  </style>
</head>
<body>
  <h1>üîç Frontend Tracking Diagnostic</h1>
  <p>This will test if the tracking APIs are reachable and working from the browser</p>

  <div>
    <button onclick="testSession()">1. Test Session Creation</button>
    <button onclick="testHeartbeat()">2. Test Heartbeat</button>
    <button onclick="testEvent()">3. Test Event</button>
    <button onclick="testFullFlow()">4. Test Full Flow</button>
    <button onclick="clearLog()">Clear Log</button>
  </div>

  <div class="log" id="log"></div>

  <script>
    let sessionId = null;

    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString();
      const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
      logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function clearLog() {
      document.getElementById('log').innerHTML = '';
    }

    async function testSession() {
      log('üìû Calling POST /api/activity/session...', 'info');

      try {
        const response = await fetch('/api/activity/session', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        log(`Response status: ${response.status} ${response.statusText}`, 'info');

        const data = await response.json();
        log(`Response data: ${JSON.stringify(data, null, 2)}`, 'info');

        if (response.ok && data.sessionId) {
          sessionId = data.sessionId;
          log(`‚úÖ SUCCESS: Session created with ID: ${sessionId}`, 'success');
        } else {
          log(`‚ùå FAILED: ${data.error || 'Unknown error'}`, 'error');
        }
      } catch (error) {
        log(`‚ùå ERROR: ${error.message}`, 'error');
      }
    }

    async function testHeartbeat() {
      if (!sessionId) {
        log('‚ùå No session ID - run Test 1 first!', 'error');
        return;
      }

      log('üíì Calling POST /api/activity/heartbeat...', 'info');

      try {
        const response = await fetch('/api/activity/heartbeat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            sessionId: sessionId,
            pagePath: '/test-page',
            activityType: 'page_active',
            metadata: { test: true }
          })
        });

        log(`Response status: ${response.status} ${response.statusText}`, 'info');

        const data = await response.json();
        log(`Response data: ${JSON.stringify(data, null, 2)}`, 'info');

        if (response.ok && data.success) {
          log(`‚úÖ SUCCESS: Heartbeat recorded with ID: ${data.heartbeatId}`, 'success');
        } else {
          log(`‚ùå FAILED: ${data.error || 'Unknown error'}`, 'error');
        }
      } catch (error) {
        log(`‚ùå ERROR: ${error.message}`, 'error');
      }
    }

    async function testEvent() {
      log('üìù Calling POST /api/activity/event...', 'info');

      try {
        const response = await fetch('/api/activity/event', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            sessionId: sessionId,
            eventType: 'page_view',
            eventData: { test: true, page: '/test' }
          })
        });

        log(`Response status: ${response.status} ${response.statusText}`, 'info');

        const data = await response.json();
        log(`Response data: ${JSON.stringify(data, null, 2)}`, 'info');

        if (response.ok && data.success) {
          log(`‚úÖ SUCCESS: Event recorded with ID: ${data.eventId}`, 'success');
        } else {
          log(`‚ùå FAILED: ${data.error || 'Unknown error'}`, 'error');
        }
      } catch (error) {
        log(`‚ùå ERROR: ${error.message}`, 'error');
      }
    }

    async function testFullFlow() {
      log('üöÄ Starting full flow test...', 'info');
      log('', 'info');

      // Test 1: Create session
      await testSession();
      await new Promise(resolve => setTimeout(resolve, 1000));
      log('', 'info');

      // Test 2: Send heartbeat
      await testHeartbeat();
      await new Promise(resolve => setTimeout(resolve, 1000));
      log('', 'info');

      // Test 3: Send another heartbeat
      log('üíì Sending second heartbeat...', 'info');
      await testHeartbeat();
      await new Promise(resolve => setTimeout(resolve, 1000));
      log('', 'info');

      // Test 4: Send event
      await testEvent();
      log('', 'info');

      log('‚úÖ Full flow test complete! Check database for data.', 'success');
    }

    // Auto-run on load
    log('üü¢ Diagnostic tool loaded. Click buttons to test.', 'success');
    log('Make sure you are logged in to your app first!', 'info');
  </script>
</body>
</html>
